#!/usr/bin/python3

import sqlite3 
# не требуется установки отдельного пакета для SQLite3 при версии питона выше 2.5
#   ДБ/таблица профилей:  id   |  profile
#    каждому профилю соответствует своя ДБ/таблица данных db_ProfileName, 
#    чтобы в случае краша просто удалить файл БД, а остальные профили сохранились
#   ДБ/таблица данных:  id   |  path    |   size    |   last_edited_date-time   |   selected_date-time

import argparse
import sys

from f_h import Version
import f_modes

#!!! from h import Profile - пока даже тут не используется и если дальше так - то и следующую строку удалить
Profile = "default"   # каждый профиль является своим набором файлов, пересечения возможны

epilog_txt = """  Примеры использования:
                ffdta -m list
                ffdta -m create !!!            
                ffdta -m use !!!
                ffdta -m create MyProfile  !!!
                ffdta --mode use MyProfile !!!
                ffdta -m delete MyProfile
            wishes and suggestions: fynjy-tox@ya.ru""" #!!! тут передача файла ещё должна быть в случае create
                                                    #, хорошо бы сделать ещё с передачей из команды после |
                                                    # в случае use указать с какой даты, количество файлов (дефаулт - всё начиная с последней не отданой)
if sys.version_info < (2, 5):
    epilog_txt += f'\n! Вы пользуетесь Python версии {sys.version}, если нет возможности установить версию пакета 2.5, или лучше, то требуется хотя бы установить пакет sqlite3 для работоспособности базовых функций !'

parser = argparse.ArgumentParser(
    prog='ffdta',
    description=f"""Bременной архив (Date-time file archive) v{Version}',
                    Используется в сочетании с другими программами для не срочного копирования большого числа файлов
                    Программа создаёт таблицу соответствий времени последнего изменения файлов,
                    Отдаёт ссылки на N самых старых файлов, которые ещё не отдавались (либо файлов, изменённых после ДАТА-ВРЕМЯ).""",
    formatter_class=argparse.RawDescriptionHelpFormatter,
    epilog=epilog_txt
)

parser.add_argument ('-m', '--mode', choices=['create', 'delete', 'use', 'list'],                    
                        help="""Указывает, что надо сделать с архивом. Обязательный параметр.
                                create -f FILES PROFILENAME: создать новый профиль
                                delete PROFILENAME: удалить профиль
                                use PROFILENAME: использовать профиль
                                list: показать список профилей"""
)

# вывести на экран доступные сеты и текст с инструкцией
# ПРОГРАММА [ ДЕЙСТВИЕ СЕТ]
# действия: использовать, создать, удалить
#  Проверки от дурака: создать можно только буквы-_, удалить то что есть, нельзя создать что есть
# к файлам префикс чтобы не создали с системным именем или именем базы-конфига


# Кргда вся выборка уже была отдана раньше, выводит сообщение до и после что эта выборка была повторно скопирована, 
#   поэтому возможно следует остановить сервис источник и скопировать всё до конца начиная с определённой ДАТЫ-ВРЕМЕНИ
#
availibleProfiles = [ 'test1', 'test2', 'default' ]   # !!! ут результат выборки из списка Profile, приведённый к строкам
parser.add_argument ('profile', choices=availibleProfiles, nargs='?', default='default',                     
                        help="""Имя выбранного профиля.
                                Каждый профиль является своим набором файлов, пересечения возможны.
                                не допускаются пробелы и символы кроме A-Z,a-z,0-9,-,_"""
)

parser.add_argument ('-f', '--files', default='./*',                     
                        help='' # не забыть проверку что только с креэйт
)

parser.add_argument ('-d', '--datetime',                      
                        help='' # не забыть проверку что только с use
)

parser.add_argument ('-n', '--n',                     
                        help='' # не забыть проверку что только с use
)

#-----------------

parser.set_defaults(func=f_modes.help)
args = parser.parse_args()

if not args.mode:           # not vars(args):
    parser.print_usage()
else:
    # centos7 использует максимум python v3.5, поэтому ещё не знакома с кейс-логикой
    # match args.mode:
    #     case 'use':
    #         parser.set_defaults(func=f_modes.use)
    #     case 'list':
    #         parser.set_defaults(func=f_modes.list)
    #     case 'create':
    #         parser.set_defaults(func=f_modes.use)
    #     case 'delete':
    #         parser.set_defaults(func=f_modes.list)
    #     case _:
    #         parser.set_defaults(func=f_modes.help)    

    try:
        modes_dict = {
            'use': parser.set_defaults(func=f_modes.use),
            'list': parser.set_defaults(func=f_modes.list),
            'create': parser.set_defaults(func=f_modes.create),
            'delete': parser.set_defaults(func=f_modes.delete)
        }

        args = parser.parse_args()

        f_modes.f_swich(modes_dict, args.mode, parser.set_defaults(func=f_modes.help))

        args.func(args)
        
    except AttributeError:
        parser.print_help()
        parser.exit()




#----------------

    # print('Режим:', args.mode)
    # print('Профиль:', args.profile)
    # print('Файл:', args.files)
    # print('Дата:', args.datetime)
    # print('Число:', args.n)

    #re.Match \w-  регэксп для проверки A-Z,a-z,0-9,-,_